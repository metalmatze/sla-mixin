alerts:
- alert: ErrorBudgetBurn
  expr: "(\n  100 * {latency:http_request_duration_seconds_bucket:ratio_rate1h} >
    (14.4*1.000000)\n  and\n  100* {latency:http_request_duration_seconds_bucket:ratio_rate5m}
    > (14.4*1.000000)\n)\nor\n(\n  100 * {latency:http_request_duration_seconds_bucket:ratio_rate6h}
    > (6*1.000000) \n  and\n  100 * {latency:http_request_duration_seconds_bucket:ratio_rate30m}
    > (6*1.000000)\n)\n"
  labels:
    handler: upload
    job: telemeter-server
    severity: critical
- alert: ErrorBudgetBurn
  expr: |
    (
      100 * {latency:http_request_duration_seconds_bucket:ratio_rate1d} > (3*1.000000)
      and
      100 * {latency:http_request_duration_seconds_bucket:ratio_rate2h} > (3*1.000000)
    )
    or
    (
      100 * {latency:http_request_duration_seconds_bucket:ratio_rate3d} > (1.000000)
      and
      100 * {latency:http_request_duration_seconds_bucket:ratio_rate6h} > (1.000000)
    )
  labels:
    handler: upload
    job: telemeter-server
    severity: warning
recordingrule:
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[5m]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate5m
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[30m]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate30m
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[1h]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate1h
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[2h]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate2h
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[6h]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate6h
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[1d]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate1d
- expr: |
    sum (rate(http_request_duration_seconds_bucket{job="telemeter-server",handler="upload"}[3d]))
    )
  labels:
    handler: upload
    job: telemeter-server
  record: sum:http_request_duration_seconds_bucket:rate3d
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate5m{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate5m{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate5m
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate30m{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate30m{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate30m
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate1h{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate1h{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate1h
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate2h{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate2h{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate2h
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate6h{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate6h{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate6h
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate1d{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate1d{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate1d
- expr: |
    1 - (sum(sum:http_request_duration_seconds_bucket:rate3d{1,le=["job=\"telemeter-server\"", "handler=\"upload\""],code!~500})
    /
    sum(sum:http_request_duration_seconds_bucket:rate3d{["job=\"telemeter-server\"", "handler=\"upload\""]}))
  labels:
    handler: upload
    job: telemeter-server
  record: latency:http_request_duration_seconds_bucket:ratio_rate3d
